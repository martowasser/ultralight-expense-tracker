# Ralph Progress Log
Started: Wed Jan 21 00:10:20 -03 2026

## Codebase Patterns
- Uses Next.js App Router with server components and server actions
- Prisma ORM with PostgreSQL, uses PrismaPg adapter for runtime
- UI follows minimal design (no component library), uses Tailwind CSS with custom CSS variables
- Server actions return `{ success: boolean; error?: string }` for mutations
- Always check `session?.user?.id` in server actions for auth
- Use `router.refresh()` after mutations to refresh server components
- Seed files should be excluded from tsconfig to avoid compilation issues
- Use `npx tsx` for running TypeScript scripts like seeds
- In Next.js 16+, "use server" files can ONLY export async functions - constants must go in separate files (e.g., constants.ts)
---

## 2026-01-21 - US-INV-032
- What was implemented: Database schema for investments module
- Files changed:
  - prisma/schema.prisma - Added Asset, Investment, Dividend, PortfolioSnapshot, PriceCache models
  - prisma/seed.ts - Created seed script for 30 pre-populated assets
  - package.json - Added db:seed script and prisma seed config
  - tsconfig.json - Excluded seed.ts from compilation
- **Learnings for future iterations:**
  - Prisma client is generated to src/generated/prisma/client
  - Currency enum expanded to 10 currencies (ARS, USD, EUR, GBP, JPY, CAD, AUD, CHF, CNY, BRL)
  - Asset precision: 6 for crypto, 2 for stocks/ETFs
  - UserSettings model exists and was extended with displayCurrency and preferredCurrencies
  - Investment model supports lot tracking with separate purchases of same asset
  - PriceCache uses symbol as primary key for efficient lookups
---

## 2026-01-21 - US-INV-001
- What was implemented: Browse Asset Library feature
- Files changed:
  - src/app/investments/actions.ts - Server actions for getAssets (with search/filter) and getAssetById
  - src/app/investments/page.tsx - Main investments page (server component)
  - src/components/AssetLibrarySection.tsx - Client component with search/filter controls
  - src/components/AssetLibraryList.tsx - Display component for assets grouped by type
  - src/components/Header.tsx - Added "investments" link to navigation
- **Learnings for future iterations:**
  - Investment module routes are at /investments
  - Assets are fetched with both global (isGlobal: true) and user-specific (userId) options
  - Type filter uses AssetType enum: CRYPTO, STOCK, ETF
  - Search is case-insensitive and matches both symbol and name
  - Debounced search (300ms) for better UX
  - Assets grouped by type in display, with type order: CRYPTO, STOCK, ETF
---

## 2026-01-21 - US-INV-002
- What was implemented: Add Investment feature
- Files changed:
  - src/app/investments/actions.ts - Added createInvestment action with validation
  - src/app/investments/constants.ts - Created for PLATFORMS and CURRENCIES constants (can't export from "use server" files)
  - src/components/AddInvestmentModal.tsx - Modal component for creating investments
  - src/components/AssetLibrarySection.tsx - Added "add investment" button to open modal
- **Learnings for future iterations:**
  - Next.js 16+ "use server" files can only export async functions - constants must be in separate files
  - Investment form includes: asset selection (with search), quantity, price, currency, date, platform, notes
  - Quantity validation respects asset precision (6 for crypto, 2 for stocks)
  - Total cost is calculated and displayed before saving
  - Common platforms provided in dropdown with "Other" option for custom entry
  - All 10 currencies are supported for investment purchases
---

## 2026-01-21 - US-INV-003
- What was implemented: Delete Investment feature
- Files changed:
  - src/app/investments/actions.ts - Added getInvestments, checkInvestmentForDeletion, deleteInvestment actions
  - src/app/investments/page.tsx - Fetches investments and passes to AssetLibrarySection
  - src/components/AssetLibrarySection.tsx - Added investments state and InvestmentsList integration
  - src/components/DeleteInvestmentModal.tsx - Confirmation modal with dividend warning
  - src/components/InvestmentsList.tsx - Displays user's investments with delete buttons
- **Learnings for future iterations:**
  - Dividends have onDelete: Cascade in schema, so deleting investment auto-deletes dividends
  - checkInvestmentForDeletion action returns hasDividends and dividendCount for warning display
  - InvestmentsList shows each investment lot with asset details, quantity, price, platform, date
  - Delete button triggers modal with confirmation and dividend count warning if applicable
  - Server action enforces userId check to prevent deleting other users' investments
---

## 2026-01-21 - US-INV-004
- What was implemented: List Investments feature with filtering and empty state
- Files changed:
  - src/components/InvestmentsList.tsx - Added filter controls (symbol, asset type, platform) and empty state with CTA
  - src/components/AssetLibrarySection.tsx - Passed onAddInvestment callback to InvestmentsList
- **Learnings for future iterations:**
  - Client-side filtering with useMemo for performance (filter by symbol/name, asset type, platform)
  - Platform filter dropdown dynamically shows only platforms user has investments on
  - Empty state includes call-to-action button that opens AddInvestmentModal
  - Filter results show "X of Y lots" when filters are active
  - Clear filters button appears when no investments match filters
---

## 2026-01-21 - US-INV-005
- What was implemented: Lot Tracking feature - holdings view that aggregates investments by symbol
- Files changed:
  - src/components/HoldingsView.tsx - New component that aggregates lots by symbol with expand/collapse
  - src/components/AssetLibrarySection.tsx - Replaced InvestmentsList with HoldingsView
- **Learnings for future iterations:**
  - HoldingsView aggregates investments into holdings grouped by symbol
  - Weighted average price = totalCost / totalQuantity for each holding
  - Holdings with multiple lots show lot count badge (e.g., "3 lots")
  - Click on holding row expands to show individual lots (only for multiple lots)
  - Each lot can be edited/deleted independently via buttons in expanded view
  - Single lot holdings show edit/delete buttons directly on the holding row
  - Lots within a holding are sorted by purchase date descending (newest first)
  - Filter by symbol/name, asset type, and platform works across aggregated holdings
  - InvestmentsList.tsx is still available but not used (HoldingsView replaced it)
---

## 2026-01-21 - US-INV-006
- What was implemented: Fetch Asset Prices feature - real-time price fetching from external APIs
- Files changed:
  - src/lib/priceService.ts - New service with Binance (crypto) and Yahoo Finance (stocks/ETFs) API integrations
  - src/app/investments/actions.ts - Added fetchAssetPrices and getCachedPrices server actions with PriceCache integration
  - src/components/AssetLibrarySection.tsx - Added price fetching on mount and refresh button
  - src/components/HoldingsView.tsx - Added price display (current price, 24h change, gain/loss, source indicator, last updated)
- **Learnings for future iterations:**
  - PriceService routes crypto to Binance API, stocks/ETFs to Yahoo Finance API
  - Binance uses SYMBOL+USDT format (e.g., BTCUSDT), Yahoo uses direct symbols
  - Prices are cached in PriceCache model with 5-minute TTL
  - CachedPrice type: { symbol, price, change24h, source, fetchedAt }
  - formatPrice helper adjusts decimal places based on price magnitude (8 decimals for < $1, 2 for > $1000)
  - formatSourceName maps source codes (binance, yahoo) to display names
  - Holdings now show: current price, 24h change (color-coded), gain/loss amount and %, source indicator
  - Prices are fetched automatically on mount and can be refreshed with button
---

## 2026-01-21 - US-INV-007
- What was implemented: Price Caching enhancements - graceful degradation and monitoring
- Files changed:
  - src/app/investments/actions.ts - Enhanced fetchAssetPrices with stale cache fallback, added clearPriceCache and getPriceCacheStats actions
  - src/components/AssetLibrarySection.tsx - Added clearPriceCache import and forceRefresh parameter support
  - src/components/HoldingsView.tsx - Added "force" button for manual cache clearing, updated formatSourceName to show "(stale)" indicator
- **Learnings for future iterations:**
  - fetchAssetPrices accepts forceRefresh param - when true, skips cache and fetches fresh prices
  - On API failure, system falls back to stale cached prices with "(cached)" suffix in source field
  - formatSourceName transforms "(cached)" to "(stale)" for user-friendly display
  - clearPriceCache action deletes cache entries for user's portfolio symbols only
  - getPriceCacheStats returns: totalCached, freshCount, staleCount, oldestFetchedAt, newestFetchedAt, cacheHitRate, symbolsCached
  - UI now has two buttons: "refresh" (uses cache if fresh) and "force" (clears cache and fetches fresh)
  - usedStaleCache flag in FetchAssetPricesResult indicates if fallback was used
---

## 2026-01-21 - US-INV-008
- What was implemented: Portfolio Dashboard feature - at-a-glance portfolio overview
- Files changed:
  - src/components/PortfolioDashboard.tsx - New component showing portfolio metrics and asset allocation
  - src/components/AssetLibrarySection.tsx - Integrated PortfolioDashboard component
- **Learnings for future iterations:**
  - PortfolioDashboard receives investments and prices arrays to calculate metrics
  - Portfolio metrics include: totalValue, totalCostBasis, totalGainLoss, gainLossPercent
  - Asset allocation calculated per type: crypto, stock, ETF with percentages
  - Visual allocation bar uses color coding: crypto=#f59e0b (amber), stock=#3b82f6 (blue), ETF=#10b981 (green)
  - Gain/loss is color-coded: green for positive, red for negative
  - Component renders nothing if no investments exist
  - Metrics recalculate automatically when prices state updates (via useMemo)
  - displayCurrency prop used for currency symbol display (defaults to USD)
---

## 2026-01-21 - US-INV-009
- What was implemented: Holdings View - responsive table (desktop) and card (mobile) views
- Files changed:
  - src/components/HoldingsView.tsx - Added responsive design with table view (md+) and card view (mobile), asset type icons with color coding
- **Learnings for future iterations:**
  - Desktop (md+) uses table layout with columns: Asset, Quantity, Avg Price, Current Price, Value, Gain/Loss, 24h, Actions
  - Mobile uses card layout with stacked information (same as before)
  - AssetTypeIcon component renders SVG icons for CRYPTO (coin), STOCK (bar chart), ETF (grid chart)
  - assetTypeColors mapping provides Tailwind-safe color classes: CRYPTO=#f59e0b, STOCK=#3b82f6, ETF=#10b981
  - Dynamic Tailwind classes (using template literals) don't work - must use pre-defined class string mappings
  - Use React.Fragment with key for table body iterations that render multiple rows
  - Expanded lot rows in table show platform, date, quantity, price, cost, and edit/delete actions
  - `hidden md:block` and `md:hidden` classes control responsive visibility
---

## 2026-01-21 - US-INV-010
- What was implemented: Edit Investment feature - modify existing investment entries
- Files changed:
  - src/app/investments/actions.ts - Added updateInvestment server action with validation and ownership check
  - src/components/EditInvestmentModal.tsx - New modal component pre-populated with current investment values
  - src/components/AssetLibrarySection.tsx - Added editingInvestment state and EditInvestmentModal integration
- **Learnings for future iterations:**
  - EditInvestmentModal mirrors AddInvestmentModal structure but pre-populates all fields from investment
  - Symbol and asset type displayed as read-only (cannot be changed - must delete and recreate)
  - Platform field checks if current platform is in PLATFORMS array using `(PLATFORMS as readonly string[]).includes()`
  - updateInvestment action verifies ownership with userId check before allowing update
  - Same validation rules apply as createInvestment (quantity precision, positive numbers, etc.)
  - onEditInvestment callback passed through HoldingsView, triggered from edit buttons on lots
  - handleEditSuccess closes modal and calls handleRefresh to update UI
---

## 2026-01-21 - US-INV-011
- What was implemented: Fallback Price Sources - automatic failover for price APIs
- Files changed:
  - src/lib/priceService.ts - Added CoinGecko and Alpha Vantage fallback APIs, automatic failover logic
  - src/components/HoldingsView.tsx - Updated formatSourceName to display "alphavantage" as "Alpha Vantage (fallback)"
- **Learnings for future iterations:**
  - CoinGecko uses coin IDs (e.g., "bitcoin", "ethereum") instead of symbols - need COINGECKO_SYMBOL_MAP
  - Alpha Vantage requires one request per symbol and uses "demo" API key for limited testing
  - Fallback functions `fetchCryptoPricesWithFallback` and `fetchStockPricesWithFallback` handle per-symbol failover
  - Source field values: "binance", "yahoo", "coingecko", "alphavantage" - formatted in UI via formatSourceName
  - Fallback sources shown as "(fallback)" suffix to indicate they were used instead of primary
  - Comprehensive console.log/console.error for monitoring price fetches and failures
---

## 2026-01-21 - US-INV-012
- What was implemented: Manual Price Refresh - header refresh button with loading state and feedback
- Files changed:
  - src/components/AssetLibrarySection.tsx - Added refresh button in header, loading indicator, timestamp display, success/error feedback toast
- **Learnings for future iterations:**
  - RefreshFeedback interface with type (success/error) and message for toast notifications
  - fetchPricesData now accepts showFeedback boolean parameter to trigger feedback display
  - formatLastUpdated function provides relative time display (just now, Xm ago, Xh ago, or date)
  - Toast auto-dismisses after 4 seconds using useEffect with cleanup
  - Spinner animation uses Tailwind animate-spin class
  - Refresh button disabled during loading with opacity-50 and cursor-not-allowed styles
---

## 2026-01-21 - US-INV-013
- What was implemented: Tab Navigation - switch between Holdings, History, and Dividends views
- Files changed:
  - src/components/AssetLibrarySection.tsx - Added tab navigation bar with three tabs, conditional content rendering
- **Learnings for future iterations:**
  - TabType union: "holdings" | "history" | "dividends" - use lowercase for consistency
  - Tab state managed via useState, defaults to "holdings" as specified in requirements
  - Tab bar uses border-b-2 styling for active indicator with transition-colors
  - Tab nav uses aria-current="page" for accessibility on active tab
  - overflow-x-auto on nav container enables horizontal scroll on narrow mobile screens
  - Holdings tab renders existing asset library and HoldingsView components
  - History and Dividends tabs show placeholder content (future stories US-INV-016-018 and US-INV-020-024)
  - Tab state is preserved during session (React state persists until page refresh)
---

## 2026-01-21 - US-INV-014
- What was implemented: Create Custom Asset feature - users can create private assets not in the library
- Files changed:
  - src/app/investments/actions.ts - Added createCustomAsset server action with validation
  - src/components/CreateCustomAssetModal.tsx - New modal for creating custom assets
  - src/components/AssetLibrarySection.tsx - Integrated modal with "+ create custom asset" button
- **Learnings for future iterations:**
  - Custom assets have isGlobal: false and userId set to the creating user's ID
  - Symbol validation: alphanumeric only, 1-10 characters, normalized to uppercase
  - Symbol uniqueness checked against both global assets and user's custom assets
  - Type-based default precision: 6 for CRYPTO, 2 for STOCK/ETF
  - Precision options available: 0, 2, 4, 6, 8 decimal places
  - Custom assets support manual price entry (no automated price fetching)
  - Modal placed next to "asset library" label for discoverability
---

## 2026-01-21 - US-INV-015
- What was implemented: Manual Price Entry feature - users can set and update prices for custom assets
- Files changed:
  - src/app/investments/actions.ts - Added setManualPrice and getCustomAssetsWithPrices server actions
  - src/components/ManualPriceModal.tsx - New modal component for entering/updating manual prices
  - src/components/HoldingsView.tsx - Added "set price" button for custom assets, "custom" badge, "manual price" indicator in blue text
- **Learnings for future iterations:**
  - Manual prices are stored in PriceCache with source "manual" - same table used for API-fetched prices
  - Custom assets identified by isGlobal: false on the asset
  - Holding interface extended with isCustom property to track which holdings are custom assets
  - Manual price indicator shown in blue text ("manual price") to differentiate from API sources
  - Pencil icon button appears next to manual prices for quick update access
  - setManualPrice validates that asset is a custom asset owned by the user before allowing price updates
---

## 2026-01-21 - US-INV-016
- What was implemented: Daily Portfolio Snapshots feature - capture and store portfolio state
- Files changed:
  - src/app/investments/actions.ts - Added capturePortfolioSnapshot, getPortfolioSnapshots, getLatestSnapshot server actions
  - src/app/api/cron/snapshots/route.ts - New API endpoint for scheduled daily snapshot capture
- **Learnings for future iterations:**
  - PortfolioSnapshot stores: totalValue, costBasis, cryptoValue, stockValue, holdings (JSON)
  - holdings JSON field stores HoldingSnapshot[] with per-symbol aggregated data
  - capturePortfolioSnapshot normalizes date to start of day to ensure only one snapshot per day
  - Cron endpoint at POST /api/cron/snapshots processes all users with investments
  - Security: Use CRON_SECRET env var for authorized cron calls (Bearer token)
  - Prisma Json field requires `as unknown as HoldingSnapshot[]` for reading and `as any` for writing
  - Snapshot includes both API-fetched prices (from PriceCache) and handles missing prices gracefully
---

## 2026-01-21 - US-INV-017
- What was implemented: Manual Snapshot feature - users can create snapshots on demand
- Files changed:
  - src/app/investments/actions.ts - Added createManualSnapshot action that creates or updates today's snapshot
  - src/components/HistoryTab.tsx - New component with create snapshot button and snapshot list display
  - src/components/AssetLibrarySection.tsx - Replaced placeholder history tab with HistoryTab component
- **Learnings for future iterations:**
  - createManualSnapshot returns wasUpdated flag to distinguish between create and update
  - HistoryTab fetches snapshots via getPortfolioSnapshots with limit 50
  - Snapshot list shows: date, value, gain/loss %, cost basis, crypto/stock allocation breakdown
  - Empty state includes call-to-action button to create first snapshot
  - Feedback toast displays success/error messages with auto-dismiss after 4 seconds
  - Reusing existing PortfolioSnapshot type - no new types needed for manual snapshots
---

## 2026-01-21 - US-INV-018
- What was implemented: Performance Chart feature - line chart showing portfolio value over time
- Files changed:
  - src/components/PerformanceChart.tsx - New Recharts-based chart component with time range selector
  - src/components/HistoryTab.tsx - Integrated PerformanceChart component
  - package.json - Added recharts dependency
- **Learnings for future iterations:**
  - Recharts library used for charting - installed via `npm install recharts`
  - Time range selector: 1W, 1M, 3M, 6M, 1Y, All - filters snapshots by date range
  - Chart onMouseMove handler uses `(state as any).activePayload` for tooltip data (TypeScript types incomplete)
  - Period return calculation: (endValue - startValue) / startValue * 100
  - Responsive chart height: h-[250px] on mobile, sm:h-[300px] on desktop
  - Custom tooltip shows date, value, and cost basis
  - Shows dots on chart only when data points <= 30 for visual clarity
  - Empty state messages for: no snapshots, and less than 2 snapshots in range
---

## 2026-01-21 - US-INV-019
- What was implemented: Chart Overlays feature - toggle to show/hide cost basis and S&P 500 benchmark on performance chart
- Files changed:
  - src/components/PerformanceChart.tsx - Added showCostBasis and showBenchmark toggles, custom legend, multi-line chart support
  - src/components/HistoryTab.tsx - Pass onFetchBenchmark callback to chart component
  - src/app/investments/actions.ts - Added getBenchmarkData action to fetch historical SPY data from Yahoo Finance
- **Learnings for future iterations:**
  - Benchmark data uses SPY ETF as S&P 500 proxy via Yahoo Finance historical API v8
  - Benchmark line is normalized to start at same value as portfolio for meaningful comparison
  - Yahoo Finance historical endpoint: /v8/finance/chart/SPY?period1=X&period2=Y&interval=1d
  - Cost basis line uses dashed style (strokeDasharray="5 5") to distinguish from solid lines
  - Colors: portfolio=#171717 (black), cost basis=#3b82f6 (blue), S&P 500=#10b981 (green)
  - onFetchBenchmark callback pattern allows parent to control data fetching while chart handles display
  - Benchmark disabled state when onFetchBenchmark is not provided
---

## 2026-01-21 - US-INV-020
- What was implemented: Record Dividend feature - users can record dividend payments from their investments
- Files changed:
  - src/app/investments/actions.ts - Added Dividend type exports and createDividend server action with validation
  - src/app/investments/constants.ts - Added DIVIDEND_TYPES constant for dropdown options
  - src/components/RecordDividendModal.tsx - New modal component for recording dividend payments
  - src/components/DividendsTab.tsx - New tab component replacing placeholder in dividends tab
  - src/components/AssetLibrarySection.tsx - Integrated DividendsTab component
- **Learnings for future iterations:**
  - Dividends are linked to individual investments (lots), not aggregated holdings
  - Investment selection dropdown groups investments by symbol using optgroup for better UX
  - DividendType enum has three values: REGULAR, SPECIAL, CAPITAL_GAIN
  - DIVIDEND_TYPES constant uses { value, label } format for dropdown options
  - Reinvested toggle uses a custom switch component (not native checkbox) for better UX
  - createDividend validates that investment exists and belongs to the current user
  - Dividend model stores investmentId to link dividends to specific lots
---
