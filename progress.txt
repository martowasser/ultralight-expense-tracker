# Ralph Progress Log
Started: Sun Jan 18 22:23:15 -03 2026
---

## Codebase Patterns
- Use `npx prisma migrate dev --name <name>` to create and apply migrations
- Prisma client is generated to `src/generated/prisma/` (gitignored)
- PostgreSQL runs in Docker container `expense-tracker-postgres` on port 5434
- Always use `@default()` for new required fields to preserve existing data
- Use `onDelete: SetNull` for optional foreign keys to prevent cascade issues
- Use `onDelete: Cascade` for required relationships (like userId)
- Run `npx prisma generate` after pulling schema changes to regenerate client
- Server actions pattern: use `"use server"` directive, auth check, validate input, return `{ success, error? }`
- Client components: use `"use client"`, useState for modal state, router.refresh() after mutations
- Modal pattern: fixed inset-0 bg-black/30 overlay, items-end sm:items-center for mobile sheet
- Import enums from `@/generated/prisma/enums`, types from actions.ts files

---

## 2026-01-18 22:25 - US-029
- What was implemented:
  - Added comprehensive Prisma schema with new models for institutions, accounts, credit cards, and user settings
  - Created enums: InstitutionType, Currency, ExpenseCategory, PaymentMethod, CardBrand
  - Created models: Institution, Account, CreditCard, UserSettings, ExpenseTag
  - Enhanced Expense model with new fields: category, currency, paymentMethod, paymentSourceId, paidWithCardId, linkedCreditCardId, isActive
  - Migration preserves existing data with defaults (category=OTHER, currency=ARS)
- Files changed:
  - prisma/schema.prisma (updated with new schema)
  - prisma/migrations/20260119012517_add_comprehensive_expense_schema/migration.sql (new migration)
- **Learnings for future iterations:**
  - Docker container `expense-tracker-postgres` needs to be started before running migrations
  - The Prisma client output is in `src/generated/prisma/` and is gitignored
  - All new fields have defaults so existing data is preserved during migrations
  - Use named relations like `@relation("PaymentSourceAccount")` when a model has multiple relations to the same target
---

## 2026-01-18 22:35 - US-020
- What was implemented:
  - Created /institutions page with full CRUD functionality
  - Institutions grouped by type (Bank, Fintech, Crypto Exchange, Payment Platform)
  - Add/Edit/Delete modals with confirmation for deletion
  - Delete confirmation shows cascade warning (accounts, credit cards that will be deleted)
  - Added navigation links in Header component to switch between expenses and institutions
- Files changed:
  - src/app/institutions/page.tsx (new - server component page)
  - src/app/institutions/actions.ts (new - server actions for CRUD)
  - src/components/InstitutionSection.tsx (new - container with modal state)
  - src/components/InstitutionList.tsx (new - list grouped by type)
  - src/components/AddInstitutionModal.tsx (new - add form modal)
  - src/components/EditInstitutionModal.tsx (new - edit form modal)
  - src/components/DeleteInstitutionModal.tsx (new - delete confirmation with cascade warning)
  - src/components/Header.tsx (updated - added navigation links)
- **Learnings for future iterations:**
  - Header now has navigation links for expenses and institutions - add new pages here
  - Use `_count` in Prisma includes to get related entity counts for cascade warnings
  - Group items by category using reduce pattern, then render with ordered keys
  - Keep modal components separate for each action (add/edit/delete) for clarity
---

## 2026-01-18 22:50 - US-021
- What was implemented:
  - Full account CRUD management within institutions
  - Server actions for create, update, delete accounts (account-actions.ts)
  - AddAccountModal: create account with name and currency (ARS/USD)
  - EditAccountModal: modify account name and currency
  - DeleteAccountModal: confirmation dialog for deletion
  - Accounts displayed under their institution on the institutions page
  - Updated InstitutionList to show "+" account button and account list
  - Updated InstitutionSection to handle all account modals
- Files changed:
  - src/app/institutions/account-actions.ts (new - server actions for accounts)
  - src/app/institutions/actions.ts (updated - include accounts in getInstitutions, export InstitutionAccount type)
  - src/components/AddAccountModal.tsx (new - add account form)
  - src/components/EditAccountModal.tsx (new - edit account form)
  - src/components/DeleteAccountModal.tsx (new - delete confirmation)
  - src/components/InstitutionList.tsx (updated - display accounts under institutions)
  - src/components/InstitutionSection.tsx (updated - handle account modals)
- **Learnings for future iterations:**
  - Re-use the same modal pattern for nested entities (accounts under institutions)
  - Pass institutionId and institutionName to AddAccountModal for context
  - Include nested entity data in parent query to avoid additional requests
  - Keep separate action files for clarity (account-actions.ts vs actions.ts)
---

## 2026-01-18 23:10 - US-022
- What was implemented:
  - Created dedicated /credit-cards page with full CRUD functionality
  - Credit cards grouped by institution on the page
  - Can add credit card with: institution, name, brand (VISA/MC/AMEX/Other), last 4 digits (optional), due day
  - Can edit credit card details (including changing institution)
  - Can delete credit card with confirmation dialog
  - Added "cards" navigation link to Header
- Files changed:
  - src/app/credit-cards/page.tsx (new - server component page)
  - src/app/credit-cards/actions.ts (new - server actions for CRUD + getInstitutionsForSelect)
  - src/components/CreditCardSection.tsx (new - container with modal state)
  - src/components/CreditCardList.tsx (new - list grouped by institution)
  - src/components/AddCreditCardModal.tsx (new - add form with institution/brand/dueDay)
  - src/components/EditCreditCardModal.tsx (new - edit form modal)
  - src/components/DeleteCreditCardModal.tsx (new - delete confirmation)
  - src/components/Header.tsx (updated - added "cards" link)
- **Learnings for future iterations:**
  - Create a getInstitutionsForSelect() helper to fetch institutions for dropdowns
  - Disable "add" button when no institutions exist (must create institutions first)
  - Input masking for lastFourDigits: use onChange with regex replace to allow only digits
  - Cards are simpler than institutions (no nested entities), so no cascade warnings needed
---

## 2026-01-18 23:55 - US-023
- What was implemented:
  - Multi-currency support for expenses (ARS/USD)
  - Currency selector added to Add and Edit expense modals
  - ExpenseList shows currency with proper formatting (US$ for USD, $ for ARS)
  - USD expenses show approximate ARS equivalent below the amount
  - ExpenseTotals shows separate ARS and USD totals
  - When USD expenses exist, combined ARS equivalent totals are shown
  - Clone expenses modal shows currency for each expense
  - getExchangeRate() action fetches rate from UserSettings (default 1200)
- Files changed:
  - src/app/dashboard/actions.ts (updated - added currency to types, exports Currency, getExchangeRate)
  - src/app/dashboard/page.tsx (updated - fetches exchange rate)
  - src/components/AddExpenseModal.tsx (updated - currency selector)
  - src/components/EditExpenseModal.tsx (updated - currency selector)
  - src/components/ExpenseList.tsx (updated - currency display with ARS equivalent)
  - src/components/ExpenseSection.tsx (updated - currency-aware totals)
  - src/components/ExpenseTotals.tsx (updated - separate ARS/USD totals)
  - src/components/CloneExpensesModal.tsx (updated - shows currency per expense)
- **Learnings for future iterations:**
  - Import Currency enum from `@/generated/prisma/enums` (not just `@/generated/prisma`)
  - Re-export types from actions.ts for client components: `export type { Currency }`
  - Use `toLocaleString("es-AR", {...})` for ARS formatting
  - Exchange rate is stored in UserSettings.usdToArsRate with default 1200
  - When adding new fields to expense interfaces, update both MonthlyExpenseWithExpense and PreviousMonthExpense
---

## 2026-01-18 - US-024
- What was implemented:
  - Added category support to expenses (Credit Card, Service, Rent, Insurance, Tax, Subscription, Building Fee, Other)
  - Category dropdown added to Add and Edit expense modals (defaults to Other)
  - ExpenseList now groups expenses by category with category headers
  - Each category shows its own subtotal (supports multi-currency ARS + USD)
  - Empty categories are automatically hidden
  - Existing expenses default to OTHER category (via schema default)
- Files changed:
  - src/app/dashboard/actions.ts (updated - added category to types, exports ExpenseCategory)
  - src/components/AddExpenseModal.tsx (updated - category selector with CATEGORY_OPTIONS)
  - src/components/EditExpenseModal.tsx (updated - category selector with CATEGORY_OPTIONS)
  - src/components/ExpenseList.tsx (updated - grouping by category, subtotals per category)
- **Learnings for future iterations:**
  - Use CATEGORY_ORDER array to control display order of categories
  - Group expenses using reduce pattern, then filter and map with CATEGORY_ORDER for consistent ordering
  - Subtotals per category need to handle multi-currency (ars + usd separately)
  - Format subtotals with "+" between currencies when both exist
---

## 2026-01-18 - US-025
- What was implemented:
  - Added collapsible "More options" section to Add and Edit expense modals
  - Payment method dropdown with options: Bank Transfer, Direct Debit, Cash, Crypto Exchange, Credit Card
  - Conditional field display: Credit Card method shows card selector, other methods show account selector
  - All payment fields are optional (progressive disclosure pattern)
  - Added getAccountsForSelect() and getCreditCardsForSelect() helper functions
  - Server-side validation for payment source ownership
  - MonthlyExpenseWithExpense type extended with paymentMethod, paymentSourceId, paidWithCardId
- Files changed:
  - src/app/dashboard/actions.ts (updated - PaymentMethod type, payment fields in interfaces, helper functions)
  - src/app/dashboard/page.tsx (updated - fetches accounts and credit cards, passes to ExpenseSection)
  - src/components/AddExpenseModal.tsx (updated - More options collapsible section, payment fields)
  - src/components/EditExpenseModal.tsx (updated - More options collapsible section, payment fields)
  - src/components/ExpenseSection.tsx (updated - accepts accounts/creditCards props, passes to modals)
- **Learnings for future iterations:**
  - Use conditional field display based on selected payment method (paymentMethod === "CREDIT_CARD" vs others)
  - Clear related selections when payment method changes to avoid inconsistent state
  - For collapsible sections, auto-expand if the expense already has data in those fields
  - Pass account/creditCard data from server component page to avoid fetching in client modals
---

## 2026-01-19 - US-026
- What was implemented:
  - When category is 'Credit Card', a card selector appears to link the expense to a specific credit card
  - Selected card auto-fills the due day from the card's due day
  - Selected card auto-fills the expense name with "Institution - Card Name" (editable by user)
  - Added linkedCreditCardId field to CreateExpenseInput, UpdateExpenseInput, and MonthlyExpenseWithExpense
  - Updated CreditCardOption interface to include dueDay for auto-fill functionality
  - Added server-side validation for linkedCreditCardId ownership
- Files changed:
  - src/app/dashboard/actions.ts (updated - linkedCreditCardId in interfaces, CreditCardOption.dueDay, getCreditCardsForSelect includes dueDay)
  - src/components/AddExpenseModal.tsx (updated - card selector when category is CREDIT_CARD, auto-fill handlers)
  - src/components/EditExpenseModal.tsx (updated - card selector when category is CREDIT_CARD, auto-fill handlers)
- **Learnings for future iterations:**
  - Extend CreditCardOption with additional fields when needed for UI (like dueDay for auto-fill)
  - Category-based conditional fields: show card selector only when category === "CREDIT_CARD"
  - Auto-fill pattern: on card selection change, find card in array and set multiple fields at once
  - linkedCreditCardId is separate from paidWithCardId - linkedCreditCardId links a credit card payment expense to its card
---

## 2026-01-19 - US-027
- What was implemented:
  - Enhanced clone behavior so Credit Card expenses clone with $0 amount
  - User is forced to enter the actual statement amount for credit card payments
  - Other expense types continue to clone with their previous month's amount
  - Added visual hint "enter statement amount" for Credit Card expenses in clone modal
  - All amounts remain editable before confirming clone
- Files changed:
  - src/components/CloneExpensesModal.tsx (updated - initializes Credit Card expenses to "0", adds hint text)
- **Learnings for future iterations:**
  - Use `expense.category === "CREDIT_CARD"` to check category (string comparison with enum value)
  - Clone modal validation requires all amounts > 0, which forces user to enter new credit card amounts
  - The previous month's amount is still displayed, so user knows what they paid last month
---

## 2026-01-19 - US-028
- What was implemented:
  - Created /settings page accessible from header navigation
  - Users can configure USD to ARS exchange rate
  - Rate saved in UserSettings table using upsert (create or update)
  - Default rate is 1200 if no settings exist
  - Rate is already used by getExchangeRate() for USD expense ARS equivalents (from US-023)
- Files changed:
  - src/app/settings/page.tsx (new - server component page)
  - src/app/settings/actions.ts (new - server actions for getUserSettings and updateSettings)
  - src/components/SettingsSection.tsx (new - client component with form for exchange rate)
  - src/components/Header.tsx (updated - added "settings" link to navigation)
- **Learnings for future iterations:**
  - Use prisma.upsert() for settings that should create or update based on userId
  - Simple settings pages don't need modals - inline form with save button works well
  - Add success message feedback after saving (useState for success state)
---
