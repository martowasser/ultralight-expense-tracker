# Ralph Progress Log
Started: Wed Jan 21 00:10:20 -03 2026

## Codebase Patterns
- Uses Next.js App Router with server components and server actions
- Prisma ORM with PostgreSQL, uses PrismaPg adapter for runtime
- UI follows minimal design (no component library), uses Tailwind CSS with custom CSS variables
- Server actions return `{ success: boolean; error?: string }` for mutations
- Always check `session?.user?.id` in server actions for auth
- Use `router.refresh()` after mutations to refresh server components
- Seed files should be excluded from tsconfig to avoid compilation issues
- Use `npx tsx` for running TypeScript scripts like seeds
- In Next.js 16+, "use server" files can ONLY export async functions - constants must go in separate files (e.g., constants.ts)
---

## 2026-01-21 - US-INV-032
- What was implemented: Database schema for investments module
- Files changed:
  - prisma/schema.prisma - Added Asset, Investment, Dividend, PortfolioSnapshot, PriceCache models
  - prisma/seed.ts - Created seed script for 30 pre-populated assets
  - package.json - Added db:seed script and prisma seed config
  - tsconfig.json - Excluded seed.ts from compilation
- **Learnings for future iterations:**
  - Prisma client is generated to src/generated/prisma/client
  - Currency enum expanded to 10 currencies (ARS, USD, EUR, GBP, JPY, CAD, AUD, CHF, CNY, BRL)
  - Asset precision: 6 for crypto, 2 for stocks/ETFs
  - UserSettings model exists and was extended with displayCurrency and preferredCurrencies
  - Investment model supports lot tracking with separate purchases of same asset
  - PriceCache uses symbol as primary key for efficient lookups
---

## 2026-01-21 - US-INV-001
- What was implemented: Browse Asset Library feature
- Files changed:
  - src/app/investments/actions.ts - Server actions for getAssets (with search/filter) and getAssetById
  - src/app/investments/page.tsx - Main investments page (server component)
  - src/components/AssetLibrarySection.tsx - Client component with search/filter controls
  - src/components/AssetLibraryList.tsx - Display component for assets grouped by type
  - src/components/Header.tsx - Added "investments" link to navigation
- **Learnings for future iterations:**
  - Investment module routes are at /investments
  - Assets are fetched with both global (isGlobal: true) and user-specific (userId) options
  - Type filter uses AssetType enum: CRYPTO, STOCK, ETF
  - Search is case-insensitive and matches both symbol and name
  - Debounced search (300ms) for better UX
  - Assets grouped by type in display, with type order: CRYPTO, STOCK, ETF
---

## 2026-01-21 - US-INV-002
- What was implemented: Add Investment feature
- Files changed:
  - src/app/investments/actions.ts - Added createInvestment action with validation
  - src/app/investments/constants.ts - Created for PLATFORMS and CURRENCIES constants (can't export from "use server" files)
  - src/components/AddInvestmentModal.tsx - Modal component for creating investments
  - src/components/AssetLibrarySection.tsx - Added "add investment" button to open modal
- **Learnings for future iterations:**
  - Next.js 16+ "use server" files can only export async functions - constants must be in separate files
  - Investment form includes: asset selection (with search), quantity, price, currency, date, platform, notes
  - Quantity validation respects asset precision (6 for crypto, 2 for stocks)
  - Total cost is calculated and displayed before saving
  - Common platforms provided in dropdown with "Other" option for custom entry
  - All 10 currencies are supported for investment purchases
---

## 2026-01-21 - US-INV-003
- What was implemented: Delete Investment feature
- Files changed:
  - src/app/investments/actions.ts - Added getInvestments, checkInvestmentForDeletion, deleteInvestment actions
  - src/app/investments/page.tsx - Fetches investments and passes to AssetLibrarySection
  - src/components/AssetLibrarySection.tsx - Added investments state and InvestmentsList integration
  - src/components/DeleteInvestmentModal.tsx - Confirmation modal with dividend warning
  - src/components/InvestmentsList.tsx - Displays user's investments with delete buttons
- **Learnings for future iterations:**
  - Dividends have onDelete: Cascade in schema, so deleting investment auto-deletes dividends
  - checkInvestmentForDeletion action returns hasDividends and dividendCount for warning display
  - InvestmentsList shows each investment lot with asset details, quantity, price, platform, date
  - Delete button triggers modal with confirmation and dividend count warning if applicable
  - Server action enforces userId check to prevent deleting other users' investments
---

## 2026-01-21 - US-INV-004
- What was implemented: List Investments feature with filtering and empty state
- Files changed:
  - src/components/InvestmentsList.tsx - Added filter controls (symbol, asset type, platform) and empty state with CTA
  - src/components/AssetLibrarySection.tsx - Passed onAddInvestment callback to InvestmentsList
- **Learnings for future iterations:**
  - Client-side filtering with useMemo for performance (filter by symbol/name, asset type, platform)
  - Platform filter dropdown dynamically shows only platforms user has investments on
  - Empty state includes call-to-action button that opens AddInvestmentModal
  - Filter results show "X of Y lots" when filters are active
  - Clear filters button appears when no investments match filters
---

## 2026-01-21 - US-INV-005
- What was implemented: Lot Tracking feature - holdings view that aggregates investments by symbol
- Files changed:
  - src/components/HoldingsView.tsx - New component that aggregates lots by symbol with expand/collapse
  - src/components/AssetLibrarySection.tsx - Replaced InvestmentsList with HoldingsView
- **Learnings for future iterations:**
  - HoldingsView aggregates investments into holdings grouped by symbol
  - Weighted average price = totalCost / totalQuantity for each holding
  - Holdings with multiple lots show lot count badge (e.g., "3 lots")
  - Click on holding row expands to show individual lots (only for multiple lots)
  - Each lot can be edited/deleted independently via buttons in expanded view
  - Single lot holdings show edit/delete buttons directly on the holding row
  - Lots within a holding are sorted by purchase date descending (newest first)
  - Filter by symbol/name, asset type, and platform works across aggregated holdings
  - InvestmentsList.tsx is still available but not used (HoldingsView replaced it)
---

## 2026-01-21 - US-INV-006
- What was implemented: Fetch Asset Prices feature - real-time price fetching from external APIs
- Files changed:
  - src/lib/priceService.ts - New service with Binance (crypto) and Yahoo Finance (stocks/ETFs) API integrations
  - src/app/investments/actions.ts - Added fetchAssetPrices and getCachedPrices server actions with PriceCache integration
  - src/components/AssetLibrarySection.tsx - Added price fetching on mount and refresh button
  - src/components/HoldingsView.tsx - Added price display (current price, 24h change, gain/loss, source indicator, last updated)
- **Learnings for future iterations:**
  - PriceService routes crypto to Binance API, stocks/ETFs to Yahoo Finance API
  - Binance uses SYMBOL+USDT format (e.g., BTCUSDT), Yahoo uses direct symbols
  - Prices are cached in PriceCache model with 5-minute TTL
  - CachedPrice type: { symbol, price, change24h, source, fetchedAt }
  - formatPrice helper adjusts decimal places based on price magnitude (8 decimals for < $1, 2 for > $1000)
  - formatSourceName maps source codes (binance, yahoo) to display names
  - Holdings now show: current price, 24h change (color-coded), gain/loss amount and %, source indicator
  - Prices are fetched automatically on mount and can be refreshed with button
---

## 2026-01-21 - US-INV-007
- What was implemented: Price Caching enhancements - graceful degradation and monitoring
- Files changed:
  - src/app/investments/actions.ts - Enhanced fetchAssetPrices with stale cache fallback, added clearPriceCache and getPriceCacheStats actions
  - src/components/AssetLibrarySection.tsx - Added clearPriceCache import and forceRefresh parameter support
  - src/components/HoldingsView.tsx - Added "force" button for manual cache clearing, updated formatSourceName to show "(stale)" indicator
- **Learnings for future iterations:**
  - fetchAssetPrices accepts forceRefresh param - when true, skips cache and fetches fresh prices
  - On API failure, system falls back to stale cached prices with "(cached)" suffix in source field
  - formatSourceName transforms "(cached)" to "(stale)" for user-friendly display
  - clearPriceCache action deletes cache entries for user's portfolio symbols only
  - getPriceCacheStats returns: totalCached, freshCount, staleCount, oldestFetchedAt, newestFetchedAt, cacheHitRate, symbolsCached
  - UI now has two buttons: "refresh" (uses cache if fresh) and "force" (clears cache and fetches fresh)
  - usedStaleCache flag in FetchAssetPricesResult indicates if fallback was used
---

## 2026-01-21 - US-INV-008
- What was implemented: Portfolio Dashboard feature - at-a-glance portfolio overview
- Files changed:
  - src/components/PortfolioDashboard.tsx - New component showing portfolio metrics and asset allocation
  - src/components/AssetLibrarySection.tsx - Integrated PortfolioDashboard component
- **Learnings for future iterations:**
  - PortfolioDashboard receives investments and prices arrays to calculate metrics
  - Portfolio metrics include: totalValue, totalCostBasis, totalGainLoss, gainLossPercent
  - Asset allocation calculated per type: crypto, stock, ETF with percentages
  - Visual allocation bar uses color coding: crypto=#f59e0b (amber), stock=#3b82f6 (blue), ETF=#10b981 (green)
  - Gain/loss is color-coded: green for positive, red for negative
  - Component renders nothing if no investments exist
  - Metrics recalculate automatically when prices state updates (via useMemo)
  - displayCurrency prop used for currency symbol display (defaults to USD)
---

## 2026-01-21 - US-INV-009
- What was implemented: Holdings View - responsive table (desktop) and card (mobile) views
- Files changed:
  - src/components/HoldingsView.tsx - Added responsive design with table view (md+) and card view (mobile), asset type icons with color coding
- **Learnings for future iterations:**
  - Desktop (md+) uses table layout with columns: Asset, Quantity, Avg Price, Current Price, Value, Gain/Loss, 24h, Actions
  - Mobile uses card layout with stacked information (same as before)
  - AssetTypeIcon component renders SVG icons for CRYPTO (coin), STOCK (bar chart), ETF (grid chart)
  - assetTypeColors mapping provides Tailwind-safe color classes: CRYPTO=#f59e0b, STOCK=#3b82f6, ETF=#10b981
  - Dynamic Tailwind classes (using template literals) don't work - must use pre-defined class string mappings
  - Use React.Fragment with key for table body iterations that render multiple rows
  - Expanded lot rows in table show platform, date, quantity, price, cost, and edit/delete actions
  - `hidden md:block` and `md:hidden` classes control responsive visibility
---

## 2026-01-21 - US-INV-010
- What was implemented: Edit Investment feature - modify existing investment entries
- Files changed:
  - src/app/investments/actions.ts - Added updateInvestment server action with validation and ownership check
  - src/components/EditInvestmentModal.tsx - New modal component pre-populated with current investment values
  - src/components/AssetLibrarySection.tsx - Added editingInvestment state and EditInvestmentModal integration
- **Learnings for future iterations:**
  - EditInvestmentModal mirrors AddInvestmentModal structure but pre-populates all fields from investment
  - Symbol and asset type displayed as read-only (cannot be changed - must delete and recreate)
  - Platform field checks if current platform is in PLATFORMS array using `(PLATFORMS as readonly string[]).includes()`
  - updateInvestment action verifies ownership with userId check before allowing update
  - Same validation rules apply as createInvestment (quantity precision, positive numbers, etc.)
  - onEditInvestment callback passed through HoldingsView, triggered from edit buttons on lots
  - handleEditSuccess closes modal and calls handleRefresh to update UI
---

## 2026-01-21 - US-INV-011
- What was implemented: Fallback Price Sources - automatic failover for price APIs
- Files changed:
  - src/lib/priceService.ts - Added CoinGecko and Alpha Vantage fallback APIs, automatic failover logic
  - src/components/HoldingsView.tsx - Updated formatSourceName to display "alphavantage" as "Alpha Vantage (fallback)"
- **Learnings for future iterations:**
  - CoinGecko uses coin IDs (e.g., "bitcoin", "ethereum") instead of symbols - need COINGECKO_SYMBOL_MAP
  - Alpha Vantage requires one request per symbol and uses "demo" API key for limited testing
  - Fallback functions `fetchCryptoPricesWithFallback` and `fetchStockPricesWithFallback` handle per-symbol failover
  - Source field values: "binance", "yahoo", "coingecko", "alphavantage" - formatted in UI via formatSourceName
  - Fallback sources shown as "(fallback)" suffix to indicate they were used instead of primary
  - Comprehensive console.log/console.error for monitoring price fetches and failures
---
